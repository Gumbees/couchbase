version: "3.8"

# CouchDB with Traefik reverse proxy configuration
# Accessible via (configure in .env):
# - Public: ${PUBLIC_COUCHDB_DOMAIN}
# - Private: ${PRIVATE_COUCHDB_DOMAIN}

services:
  couchdb:
    image: couchdb:latest
    container_name: ${CONTAINER_NAME_PREFIX}-app
    restart: unless-stopped
    environment:
      - COUCHDB_USER=${COUCHDB_USER}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
      - TZ=${TZ}
    volumes:
      - couchdb_data:/opt/couchdb/data
    networks:
      - app-network
      - traefik_public
    # Configure CouchDB to listen on all interfaces for Traefik access
    command: >
      --bind_address 0.0.0.0
    labels:
      # Public domain - ${PUBLIC_COUCHDB_DOMAIN}
      - "traefik.enable=true"
      - "traefik.http.routers.couchdb-public.rule=Host(`${PUBLIC_COUCHDB_DOMAIN}`)"
      - "traefik.http.routers.couchdb-public.entrypoints=websecure"
      - "traefik.http.routers.couchdb-public.tls.certresolver=letsencrypt"
      - "traefik.http.services.couchdb-public.loadbalancer.server.port=5984"
      
      # Private domain - ${PRIVATE_COUCHDB_DOMAIN}
      - "traefik.http.routers.couchdb-private.rule=Host(`${PRIVATE_COUCHDB_DOMAIN}`)"
      - "traefik.http.routers.couchdb-private.entrypoints=websecure"
      - "traefik.http.routers.couchdb-private.tls.certresolver=letsencrypt"
      - "traefik.http.services.couchdb-private.loadbalancer.server.port=5984"

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: ${CONTAINER_NAME_PREFIX}-cloudflared
    restart: unless-stopped
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    # This command checks if the token is set before running the tunnel
    # Note: Cloudflare Tunnel may not be needed if Traefik is handling external access
    command: sh -c 'if [ -n "$TUNNEL_TOKEN" ]; then cloudflared tunnel --no-autoupdate run --token $TUNNEL_TOKEN; else echo "CLOUDFLARE_TUNNEL_TOKEN is not set. Service is idle." && tail -f /dev/null; fi'
    networks:
      - app-network
      - traefik_public

volumes:
  couchdb_data:
    name: ${CONTAINER_NAME_PREFIX}-data

networks:
  app-network:
    name: ${CONTAINER_NAME_PREFIX}-app
  traefik_public:
    external: true